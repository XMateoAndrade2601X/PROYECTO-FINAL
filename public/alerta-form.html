<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formulario de Alerta</title>
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f6fa;
      padding: 20px;
    }
    h2 { text-align: center; color: #2f3640; }
    form {
      max-width: 500px;
      margin: auto;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    label { margin-top: 15px; display: block; }
    input[type=text], textarea {
      width: 100%; padding: 10px; margin-top: 5px;
      border: 1px solid #ccc; border-radius: 5px;
    }
    textarea { resize: vertical; min-height: 80px; }
    .opciones-radio label {
      display: flex; align-items: center; margin-top: 5px;
    }
    .opciones-radio input {
      margin-right: 10px;
    }
    button {
      background-color: #273c75; color: white; border: none;
      padding: 12px; margin-top: 20px; width: 100%;
      border-radius: 5px; font-size: 16px; cursor: pointer;
    }
    button:hover { background-color: #40739e; }
    .small-btn {
      background-color: #dcdde1; color: #2f3640; font-size: 14px;
      margin-top: 10px; width: 100%;
    }
    #mensajeFinal, #permisosMsg {
      text-align: center; margin-top: 30px;
    }
    .hidden { display: none; }
  </style>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAh90IRuc-aJYS35YnhGMHKBWXeahDzjt8",
      authDomain: "silencioseguro-c2c79.firebaseapp.com",
      projectId: "silencioseguro-c2c79",
      storageBucket: "silencioseguro-c2c79.appspot.com",
      messagingSenderId: "765440815981",
      appId: "1:765440815981:web:136fa7806d3d0c96762064",
      measurementId: "G-GLW28V0GCX"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.enviarAlerta = async function(e) {
      e.preventDefault();

      const descripcionEscrita = document.getElementById("descripcion").value.trim();
      const descripcionFinal = descripcionEscrita + (window.descripcionDictada ? ". Transcripci√≥n por voz: " + window.descripcionDictada : "");

      try {
        await addDoc(collection(db, "alertas"), {
          nombre: document.getElementById("nombre").value || "An√≥nimo",
          telefono: document.getElementById("telefono").value || "No proporcionado",
          tipo: document.getElementById("tipo").value,
          sexo_victima: document.querySelector('input[name="sexoVictima"]:checked')?.value || "",
          agresor_tipo: document.getElementById("agresorTipo").value,
          sexo_agresor: document.querySelector('input[name="sexoAgresor"]:checked')?.value || "",
          descripcion: descripcionFinal,
          ubicacion: document.getElementById("ubicacion").value,
          mensaje: "Recibido desde dictado y formulario",
          fecha: serverTimestamp()
        });
        document.getElementById("formularioAlerta").classList.add("hidden");
        document.getElementById("mensajeFinal").classList.remove("hidden");
      } catch (err) {
        alert("Error al enviar: " + err.message);
      }
    }
  </script>
</head>
<body>

<div id="permisosMsg">
  üîî Dale permisos de ubicaci√≥n y micr√≥fono para agilizar tu alerta.
</div>

<h2>Formulario de Alerta - <span id="tipoTitulo">Violencia</span></h2>
<form id="formularioAlerta" onsubmit="enviarAlerta(event)">
  <input type="hidden" id="tipo" value="Violencia F√≠sica" />

  <label>Nombre (opcional):</label>
  <input type="text" id="nombre" placeholder="Ej. An√≥nimo" />

  <label>Sexo de la v√≠ctima:</label>
  <div class="opciones-radio">
    <label><input type="radio" name="sexoVictima" value="Femenino" />Femenino</label>
    <label><input type="radio" name="sexoVictima" value="Masculino" />Masculino</label>
    <label><input type="radio" name="sexoVictima" value="No binario" />No binario</label>
  </div>

  <label>Tel√©fono (opcional):</label>
    <input type="tel" id="telefono" placeholder="Ej. 987654321" pattern="[0-9]{9}" />


  <label>¬øQui√©n comete la agresi√≥n?</label>
  <select id="agresorTipo" required>
    <option value="">Selecciona</option>
    <option>Familiar</option>
    <option>Conocido</option>
    <option>Desconocido</option>
  </select>

  <label>Sexo del agresor:</label>
  <div class="opciones-radio">
    <label><input type="radio" name="sexoAgresor" value="Femenino" />Femenino</label>
    <label><input type="radio" name="sexoAgresor" value="Masculino" />Masculino</label>
    <label><input type="radio" name="sexoAgresor" value="No identificado" />No identificado</label>
  </div>

  <label>Descripci√≥n del caso:</label>
  <textarea id="descripcion" placeholder="Describe lo que ocurri√≥..."></textarea>
  <button type="button" class="small-btn" onclick="iniciarReconocimiento()">üéôÔ∏è Dictar / Cancelar</button>
  <span id="estadoVoz"></span>

  <label>Ubicaci√≥n:</label>
  <input type="text" id="ubicacion" readonly />

  <button type="submit">üì® Enviar Alerta</button>
</form>

<div id="mensajeFinal" class="hidden">
  <h3>Mant√©n la calma</h3>
  <p>Recibimos tu alerta. Nuestro equipo responder√° pronto.</p>
  <button onclick="window.location.href='tel:+105'">üìû Llamar 105</button>
  <button onclick="window.open('https://wa.me/51984141404')">üí¨ WhatsApp L√≠nea 100</button>
</div>

<script>
  let reconocimiento;
  let escuchando = false;
  window.descripcionDictada = "";

  function iniciarReconocimiento() {
    const estado = document.getElementById("estadoVoz");

    if (escuchando && reconocimiento) {
      reconocimiento.stop();
      escuchando = false;
      estado.textContent = "üõë Dictado cancelado";
      return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      estado.textContent = "‚ùå Tu navegador no soporta esta funci√≥n.";
      return;
    }

    reconocimiento = new SpeechRecognition();
    reconocimiento.lang = 'es-PE';
    reconocimiento.continuous = false;
    reconocimiento.interimResults = false;

    reconocimiento.onstart = () => {
      escuchando = true;
      estado.textContent = "üé§ Escuchando... pulsa de nuevo para cancelar";
    };

    reconocimiento.onresult = (event) => {
      window.descripcionDictada = event.results[0][0].transcript;
      estado.textContent = "‚úÖ Capturado: " + window.descripcionDictada;
      escuchando = false;
    };

    reconocimiento.onerror = (event) => {
      estado.textContent = "‚ùå Error: " + event.error;
      escuchando = false;
    };

    reconocimiento.onend = () => {
      if (!window.descripcionDictada) estado.textContent = "‚ö†Ô∏è No se capt√≥ audio";
      escuchando = false;
    };

    reconocimiento.start();
  }

  // Geolocalizaci√≥n autom√°tica
  window.onload = () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude.toFixed(5);
        const lon = pos.coords.longitude.toFixed(5);
        document.getElementById("ubicacion").value = `Lat: ${lat}, Lon: ${lon}`;
      }, err => {
        document.getElementById("ubicacion").value = "No se pudo obtener ubicaci√≥n.";
      });
    }
  };
</script>

</body>
</html>


