<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Derivar Alerta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #ffffff, #dcdde1);
      padding: 30px;
      color: #2f3640;
    }
    h2, h3 {
      text-align: center;
      margin-bottom: 20px;
    }
    .entidades {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }
    .entidad {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 250px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
      transition: 0.3s;
    }
    .entidad:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }
    .entidad button {
      margin-top: 10px;
      background-color: #273c75;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
    }
    .entidad button:hover {
      background-color: #40739e;
    }
    .volver {
      display: block;
      margin: 40px auto 0;
      background-color: #44bd32;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAh90IRuc-aJYS35YnhGMHKBWXeahDzjt8",
      authDomain: "silencioseguro-c2c79.firebaseapp.com",
      projectId: "silencioseguro-c2c79",
      storageBucket: "silencioseguro-c2c79.appspot.com",
      messagingSenderId: "765440815981",
      appId: "1:765440815981:web:136fa7806d3d0c96762064"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const correosEntidad = {
      "PNP": "denuncias@pnp.gob.pe",
      "Fiscal√≠a": "informes@mpfn.gob.pe",
      "Centro de Emergencia Mujer": "alerta@cem.gob.pe",
      "L√≠nea 100": "linea100@mimp.gob.pe",
      "DEMUNA": "demuna@municipalidad.gob.pe",
      "CEM": "cemcentral@mimp.gob.pe",
      "Ministerio de la Mujer": "contacto@mimp.gob.pe",
      "Defensor√≠a del Pueblo": "quejas@defensoria.gob.pe",
      "Asistencia Legal Gratuita": "consultas@minjus.gob.pe"
    };

    const alertaId = new URLSearchParams(window.location.search).get("id");
    let alertaData = null;

    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        alert("Debes iniciar sesi√≥n.");
        window.location.href = "login.html";
      } else {
        db.collection("alertas").doc(alertaId).get().then(doc => {
          if (doc.exists) {
            alertaData = doc.data();
            construirEntidades(alertaData.tipo);
          } else {
            alert("Alerta no encontrada.");
            window.location.href = "admin.html";
          }
        });
      }
    });

    function construirEntidades(tipo) {
      document.getElementById("subtitulo").textContent = "Entidades para: " + tipo;
      const entidades = {
        "Violencia F√≠sica": ["PNP", "Fiscal√≠a", "Centro de Emergencia Mujer", "L√≠nea 100"],
        "Violencia Psicol√≥gica": ["DEMUNA", "CEM", "L√≠nea 100"],
        "Violencia Sexual": ["Ministerio de la Mujer", "CEM", "L√≠nea 100"],
        "Violencia Econ√≥mica": ["Defensor√≠a del Pueblo", "DEMUNA", "Asistencia Legal Gratuita"]
      }[tipo] || ["L√≠nea 100"];

      const contenedor = document.getElementById("contenedor");
      entidades.forEach(entidad => {
        const card = document.createElement("div");
        card.className = "entidad";
        card.innerHTML = `<h4>${entidad}</h4>
          <button onclick="derivarEntidad('${entidad}')">Derivar Ahora</button>`;
        contenedor.appendChild(card);
      });
    }

    function derivarEntidad(nombreEntidad) {
      const user = firebase.auth().currentUser;
      const correoDestino = correosEntidad[nombreEntidad] || "entidad@correo.com";

      const datos = alertaData;
      const cuerpo = `
üö® NUEVA DERIVACI√ìN DE ALERTA

üë§ Nombre: ${datos.nombre || "An√≥nimo"}
üìÑ Tipo de Violencia: ${datos.tipo}
üìù Descripci√≥n: ${datos.descripcion}
üìç Ubicaci√≥n: ${datos.distrito || ""}, ${datos.direccion || ""}
üìß Derivado por: ${user.email}
‚è∞ Fecha: ${new Date().toLocaleString()}
      `;

      db.collection("derivaciones").add({
        tipo: datos.tipo,
        entidad: nombreEntidad,
        derivadoPor: user.email,
        alertaId: alertaId,
        fecha: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        const subject = encodeURIComponent("Derivaci√≥n de alerta - " + datos.tipo);
        const body = encodeURIComponent(cuerpo);
        const mailto = `mailto:${correoDestino}?subject=${subject}&body=${body}`;
        alert("Correo preparado para enviar a: " + nombreEntidad);
        window.open(mailto, "_blank");
        window.location.href = "admin.html";
      }).catch(err => {
        alert("Error al guardar derivaci√≥n: " + err.message);
      });
    }
  </script>
</head>

<body>
  <h2>Derivar Alerta</h2>
  <h3 id="subtitulo"></h3>

  <div class="entidades" id="contenedor"></div>

  <button class="volver" onclick="window.location.href='admin.html'">‚Üê Volver al Panel</button>
</body>
</html>
